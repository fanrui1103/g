<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>概率分布分析工具 - 综合数据分析平台</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h1 {
            color: #2c3e50;
            font-size: 28px;
            margin-bottom: 10px;
        }

        h2 {
            color: #34495e;
            font-size: 22px;
            margin: 20px 0 15px;
        }

        .tabs {
            display: flex;
            background-color: #fff;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 500;
            color: #7f8c8d;
        }

        .tab.active {
            background-color: #3498db;
            color: white;
        }

        .tab-content {
            background-color: #fff;
            padding: 25px;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        .generator-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            min-width: 200px;
            flex: 1;
        }

        label {
            margin-bottom: 5px;
            font-weight: 500;
            color: #2c3e50;
        }

        select, input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: 500;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #7f8c8d;
        }

        .btn-success {
            background-color: #2ecc71;
            color: white;
        }

        .btn-success:hover {
            background-color: #27ae60;
        }

        .distribution-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 14px;
        }

        .chart-container {
            margin-top: 20px;
            height: 400px;
            position: relative;
        }

        .chart-controls {
            margin-top: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .result-card {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #3498db;
        }

        .result-label {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .result-value {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
        }

        /* AI生成数据和文件上传功能样式 */
        .ai-section {
            background-color: #f0f4f8;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #8e44ad;
        }

        .file-upload-section {
            background-color: #e8f4ea;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #27ae60;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            margin-bottom: 10px;
        }

        .file-input-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }

        .file-input-label {
            display: inline-block;
            padding: 10px 15px;
            background-color: #3498db;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }

        .file-name {
            margin-left: 10px;
            font-style: italic;
            color: #7f8c8d;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .results-grid {
                grid-template-columns: 1fr;
            }
        }

        /* AI生成数据和文件上传功能样式 */
        .ai-section {
            background-color: #f0f4f8;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #8e44ad;
        }

        .file-upload-section {
            background-color: #e8f4ea;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #27ae60;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            margin-bottom: 10px;
        }

        .file-input-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }

        .file-input-label {
            display: inline-block;
            padding: 10px 15px;
            background-color: #3498db;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }

        .file-name {
            margin-left: 10px;
            font-style: italic;
            color: #7f8c8d;
        }
        
        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .loading-indicator {
            display: none;
            text-align: center;
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>概率分布分析工具</h1>
            <p>用于生成和分析各种概率分布的数据</p>
        </header>

        <div class="tabs">
            <button class="tab active" data-tab="generator">分布生成</button>
            <button class="tab" data-tab="analysis">数据分析</button>
            <button class="tab" data-tab="about">关于工具</button>
        </div>

        <div class="tab-content">
            <!-- 分布生成标签页 -->
            <div class="tab-panel active" id="generator">
                <div class="generator-section">
                    <div class="control-group">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="distribution-type">分布类型</label>
                                <select id="distribution-type">
                                    <option value="normal">正态分布</option>
                                    <option value="binomial">二项分布</option>
                                    <option value="poisson">泊松分布</option>
                                    <option value="exponential">指数分布</option>
                                    <option value="uniform">均匀分布</option>
                                </select>
                            </div>
                            
                            <!-- 正态分布参数 -->
                            <div id="normal-params" class="param-group">
                                <div class="form-group">
                                    <label for="mean">均值 (μ)</label>
                                    <input type="number" id="mean" value="0" step="0.1">
                                </div>
                                <div class="form-group">
                                    <label for="std-dev">标准差 (σ)</label>
                                    <input type="number" id="std-dev" value="1" step="0.1" min="0.1">
                                </div>
                            </div>
                            
                            <!-- 二项分布参数 -->
                            <div id="binomial-params" class="param-group" style="display: none;">
                                <div class="form-group">
                                    <label for="trials">试验次数 (n)</label>
                                    <input type="number" id="trials" value="10" min="1">
                                </div>
                                <div class="form-group">
                                    <label for="probability">成功概率 (p)</label>
                                    <input type="number" id="probability" value="0.5" step="0.01" min="0" max="1">
                                </div>
                            </div>
                            
                            <!-- 泊松分布参数 -->
                            <div id="poisson-params" class="param-group" style="display: none;">
                                <div class="form-group">
                                    <label for="lambda">λ 参数</label>
                                    <input type="number" id="lambda" value="5" step="0.1" min="0.1">
                                </div>
                            </div>
                            
                            <!-- 指数分布参数 -->
                            <div id="exponential-params" class="param-group" style="display: none;">
                                <div class="form-group">
                                    <label for="rate">率参数 (λ)</label>
                                    <input type="number" id="rate" value="1" step="0.1" min="0.1">
                                </div>
                            </div>
                            
                            <!-- 均匀分布参数 -->
                            <div id="uniform-params" class="param-group" style="display: none;">
                                <div class="form-group">
                                    <label for="min">最小值 (a)</label>
                                    <input type="number" id="min" value="0" step="0.1">
                                </div>
                                <div class="form-group">
                                    <label for="max">最大值 (b)</label>
                                    <input type="number" id="max" value="1" step="0.1">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="sample-size">样本大小</label>
                                <input type="number" id="sample-size" value="1000" min="10" max="100000">
                            </div>
                            
                            <div class="form-group" style="flex: 0 0 auto;">
                                <button id="generate-btn" class="btn btn-primary">生成数据</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="distribution-info" class="distribution-info">
                        请选择分布类型并调整参数，然后点击生成按钮。
                    </div>
                    
                    <!-- AI生成数据部分 -->
                    <div class="ai-section">
                        <h2>AI生成数据</h2>
                        <div class="form-group">
                            <label for="ai-description">描述您需要的数据模式</label>
                            <textarea id="ai-description" rows="3" placeholder="例如：生成一组符合正态分布的考试成绩数据，均值75，标准差10，包含1000个样本..."></textarea>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button id="ai-generate-btn" class="btn btn-secondary">AI生成数据</button>
                            <button id="ai-api-setup-btn" class="btn btn-info">设置API密钥</button>
                        </div>
                    </div>
                    
                    <!-- 文件上传部分 -->
                    <div class="file-upload-section">
                        <h2>上传数据文件</h2>
                        <div class="form-group">
                            <div class="file-input-wrapper">
                                <input type="file" id="file-upload" accept=".csv">
                                <label for="file-upload" class="file-input-label">浏览文件</label>
                                <span id="file-name" class="file-name">未选择文件</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="data-column">数据列名称（留空则自动检测）</label>
                            <input type="text" id="data-column" placeholder="例如：value, score, data 等">
                        </div>
                        <button id="upload-btn" class="btn btn-success">上传并分析</button>
                    </div>
                    
                    <div id="loading" class="loading-indicator">
                        <p>正在处理数据，请稍候...</p>
                    </div>
                    
                    <div class="chart-controls">
                        <div class="form-group">
                            <label for="chart-type">图表类型</label>
                            <select id="chart-type">
                                <option value="bar">直方图</option>
                                <option value="line">折线图</option>
                                <option value="scatter">散点图</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="distribution-chart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- 数据分析标签页 -->
            <div class="tab-panel" id="analysis">
                <h2>统计分析结果</h2>
                <div id="analysis-results" class="results-grid">
                    <!-- 分析结果将在这里动态生成 -->
                </div>
            </div>
            
            <!-- 关于工具标签页 -->
            <div class="tab-panel" id="about">
                <h2>关于概率分布分析工具</h2>
                <p>这是一个用于生成和分析各种概率分布的工具，支持以下分布类型：</p>
                <ul>
                    <li>正态分布</li>
                    <li>二项分布</li>
                    <li>泊松分布</li>
                    <li>指数分布</li>
                    <li>均匀分布</li>
                </ul>
                <p>工具功能包括：</p>
                <ul>
                    <li>生成指定分布的随机样本数据</li>
                    <li>可视化分布的概率密度函数和直方图</li>
                    <li>计算基本统计量（均值、中位数、众数、方差等）</li>
                    <li>AI辅助数据生成（通过自然语言描述）</li>
                    <li>CSV文件上传和分析</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // 分布计算器类
        class DistributionCalculator {
            constructor() {}
            
            // 正态分布 PDF
            normalPDF(x, mean = 0, stdDev = 1) {
                const sqrtTwoPi = Math.sqrt(2 * Math.PI);
                return Math.exp(-0.5 * Math.pow((x - mean) / stdDev, 2)) / (stdDev * sqrtTwoPi);
            }
            
            // 生成正态分布样本
            generateNormal(mean = 0, stdDev = 1, sampleSize = 1000) {
                const samples = [];
                for (let i = 0; i < sampleSize; i++) {
                    // Box-Muller 变换
                    let u1 = 0, u2 = 0;
                    while (u1 === 0) u1 = Math.random();
                    while (u2 === 0) u2 = Math.random();
                    
                    const z0 = Math.sqrt(-2.0 * Math.log(u1)) * Math.cos(2.0 * Math.PI * u2);
                    samples.push(z0 * stdDev + mean);
                }
                return samples;
            }
            
            // 二项分布 PMF
            binomialPMF(k, n = 10, p = 0.5) {
                if (k < 0 || k > n) return 0;
                const comb = this.combination(n, k);
                return comb * Math.pow(p, k) * Math.pow(1 - p, n - k);
            }
            
            // 生成二项分布样本
            generateBinomial(n = 10, p = 0.5, sampleSize = 1000) {
                const samples = [];
                for (let i = 0; i < sampleSize; i++) {
                    let successes = 0;
                    for (let j = 0; j < n; j++) {
                        if (Math.random() < p) {
                            successes++;
                        }
                    }
                    samples.push(successes);
                }
                return samples;
            }
            
            // 泊松分布 PMF
            poissonPMF(k, lambda = 5) {
                if (k < 0) return 0;
                return (Math.exp(-lambda) * Math.pow(lambda, k)) / this.factorial(k);
            }
            
            // 生成泊松分布样本
            generatePoisson(lambda = 5, sampleSize = 1000) {
                const samples = [];
                for (let i = 0; i < sampleSize; i++) {
                    let k = 0;
                    let p = 1;
                    const L = Math.exp(-lambda);
                    do {
                        k++;
                        p *= Math.random();
                    } while (p > L);
                    samples.push(k - 1);
                }
                return samples;
            }
            
            // 指数分布 PDF
            exponentialPDF(x, rate = 1) {
                if (x < 0) return 0;
                return rate * Math.exp(-rate * x);
            }
            
            // 生成指数分布样本
            generateExponential(rate = 1, sampleSize = 1000) {
                const samples = [];
                for (let i = 0; i < sampleSize; i++) {
                    const u = Math.random();
                    samples.push(-Math.log(1 - u) / rate);
                }
                return samples;
            }
            
            // 均匀分布 PDF
            uniformPDF(x, min = 0, max = 1) {
                if (x < min || x > max) return 0;
                return 1 / (max - min);
            }
            
            // 生成均匀分布样本
            generateUniform(min = 0, max = 1, sampleSize = 1000) {
                const samples = [];
                for (let i = 0; i < sampleSize; i++) {
                    samples.push(min + Math.random() * (max - min));
                }
                return samples;
            }
            
            // 组合数计算
            combination(n, k) {
                if (k === 0 || k === n) return 1;
                if (k > n) return 0;
                k = Math.min(k, n - k);
                let result = 1;
                for (let i = 1; i <= k; i++) {
                    result = result * (n - k + i) / i;
                }
                return result;
            }
            
            // 阶乘计算
            factorial(n) {
                if (n === 0 || n === 1) return 1;
                let result = 1;
                for (let i = 2; i <= n; i++) {
                    result *= i;
                }
                return result;
            }
        }
        
        // 统计分析器类
        class StatisticalAnalyzer {
            constructor() {}
            
            // 计算均值
            mean(data) {
                const sum = data.reduce((acc, val) => acc + val, 0);
                return sum / data.length;
            }
            
            // 计算中位数
            median(data) {
                const sortedData = [...data].sort((a, b) => a - b);
                const midIndex = Math.floor(sortedData.length / 2);
                
                if (sortedData.length % 2 === 0) {
                    return (sortedData[midIndex - 1] + sortedData[midIndex]) / 2;
                } else {
                    return sortedData[midIndex];
                }
            }
            
            // 计算众数
            mode(data) {
                const frequencyMap = new Map();
                let maxFrequency = 0;
                let modes = [];
                
                for (const value of data) {
                    const frequency = (frequencyMap.get(value) || 0) + 1;
                    frequencyMap.set(value, frequency);
                    
                    if (frequency > maxFrequency) {
                        maxFrequency = frequency;
                        modes = [value];
                    } else if (frequency === maxFrequency) {
                        modes.push(value);
                    }
                }
                
                return modes;
            }
            
            // 计算方差
            variance(data) {
                const avg = this.mean(data);
                const squaredDifferences = data.map(value => Math.pow(value - avg, 2));
                return this.mean(squaredDifferences);
            }
            
            // 计算标准差
            stdDev(data) {
                return Math.sqrt(this.variance(data));
            }
            
            // 计算偏度
            skewness(data) {
                const avg = this.mean(data);
                const std = this.stdDev(data);
                const n = data.length;
                
                if (std === 0) return 0;
                
                const thirdMoment = data.reduce((acc, val) => acc + Math.pow((val - avg) / std, 3), 0) / n;
                return thirdMoment;
            }
            
            // 计算峰度
            kurtosis(data) {
                const avg = this.mean(data);
                const std = this.stdDev(data);
                const n = data.length;
                
                if (std === 0) return 0;
                
                const fourthMoment = data.reduce((acc, val) => acc + Math.pow((val - avg) / std, 4), 0) / n;
                return fourthMoment - 3; // 超额峰度
            }
            
            // 计算四分位数
            quartiles(data) {
                const sortedData = [...data].sort((a, b) => a - b);
                const n = sortedData.length;
                
                const q1Index = Math.floor(n * 0.25);
                const q2Index = Math.floor(n * 0.5);
                const q3Index = Math.floor(n * 0.75);
                
                return {
                    q1: sortedData[q1Index],
                    q2: sortedData[q2Index],
                    q3: sortedData[q3Index]
                };
            }
            
            // 计算最小值
            min(data) {
                return Math.min(...data);
            }
            
            // 计算最大值
            max(data) {
                return Math.max(...data);
            }
        }
        
        // 数据可视化类
        class DataVisualizer {
            constructor() {
                this.chart = null;
            }
            
            // 创建分布图表
            createDistributionChart(canvasId, data, distributionType, params, title = '') {
                const ctx = document.getElementById(canvasId).getContext('2d');
                const calculator = new DistributionCalculator();
                
                // 如果已有图表，销毁它
                if (this.chart) {
                    this.chart.destroy();
                }
                
                // 创建直方图数据
                const histogramData = this.createHistogramBins(data, 50);
                
                // 创建分布曲线数据
                let distributionData = [];
                let xAxis = [];
                
                if (histogramData.length > 0) {
                    const min = Math.min(...data);
                    const max = Math.max(...data);
                    const range = max - min;
                    const padding = range * 0.1;
                    
                    const numPoints = 200;
                    for (let i = 0; i <= numPoints; i++) {
                        const x = min - padding + (range + 2 * padding) * i / numPoints;
                        xAxis.push(x);
                        
                        let y = 0;
                        switch (distributionType) {
                            case 'normal':
                                y = calculator.normalPDF(x, params.mean, params.stdDev);
                                break;
                            case 'binomial':
                                // 对于离散分布，只在整数点计算
                                if (Math.abs(x - Math.round(x)) < 0.1) {
                                    y = calculator.binomialPMF(Math.round(x), params.trials, params.probability);
                                }
                                break;
                            case 'poisson':
                                // 对于离散分布，只在整数点计算
                                if (Math.abs(x - Math.round(x)) < 0.1) {
                                    y = calculator.poissonPMF(Math.round(x), params.lambda);
                                }
                                break;
                            case 'exponential':
                                y = calculator.exponentialPDF(x, params.rate);
                                break;
                            case 'uniform':
                                y = calculator.uniformPDF(x, params.min, params.max);
                                break;
                        }
                        distributionData.push(y);
                    }
                }
                
                // 设置图表标题
                let chartTitle = '';
                if (title) {
                    chartTitle = title;
                } else {
                    switch (distributionType) {
                        case 'normal':
                            chartTitle = `正态分布 N(${params.mean}, ${params.stdDev})`;
                            break;
                        case 'binomial':
                            chartTitle = `二项分布 B(${params.trials}, ${params.probability})`;
                            break;
                        case 'poisson':
                            chartTitle = `泊松分布 P(${params.lambda})`;
                            break;
                        case 'exponential':
                            chartTitle = `指数分布 Exp(${params.rate})`;
                            break;
                        case 'uniform':
                            chartTitle = `均匀分布 U(${params.min}, ${params.max})`;
                            break;
                    }
                }
                
                // 获取图表类型选择器的值
            const chartTypeSelect = document.getElementById('chart-type');
            const chartType = chartTypeSelect ? chartTypeSelect.value : 'bar';

            // 创建图表
                this.chart = new Chart(ctx, {
                    type: chartType,
                    data: {
                        labels: histogramData.map(bin => bin.midpoint.toFixed(2)),
                        datasets: [
                              {
                                label: chartType === 'bar' ? '直方图' : (chartType === 'line' ? '数据分布' : '数据点'),
                                data: chartType === 'scatter' 
                                    ? data.slice(0, 500).map((value, index) => ({x: index, y: value}))
                                    : histogramData.map(bin => bin.count),
                                backgroundColor: chartType === 'scatter' ? 'rgba(52, 152, 219, 0.5)' : 'rgba(52, 152, 219, 0.5)',
                                borderColor: chartType === 'scatter' ? 'rgba(52, 152, 219, 1)' : 'rgba(52, 152, 219, 1)',
                                borderWidth: chartType === 'scatter' ? 2 : 1,
                                categoryPercentage: chartType === 'bar' ? 1 : undefined,
                                barPercentage: chartType === 'bar' ? 1 : undefined,
                                pointRadius: chartType === 'scatter' ? 3 : (chartType === 'line' ? 0 : undefined),
                                fill: chartType === 'line' ? false : (chartType === 'bar' ? true : false),
                                showLine: chartType === 'line'
                              }
                            ].concat(chartType !== 'scatter' ? [{
                                label: '理论分布',
                                data: distributionData,
                                type: 'line',
                                borderColor: 'rgba(231, 76, 60, 1)',
                                borderWidth: 2,
                                pointRadius: 0,
                                fill: false,
                                yAxisID: 'y1'
                            }] : [])
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: chartTitle,
                                font: {
                                    size: 16
                                }
                            },
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: chartType === 'scatter' ? '数值' : '频数'
                                }
                            },
                            y1: {
                                beginAtZero: true,
                                position: 'right',
                                grid: {
                                    drawOnChartArea: false
                                },
                                title: {
                                    display: true,
                                    text: '概率密度/质量'
                                },
                                display: chartType !== 'scatter'
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: chartType === 'scatter' ? '样本索引' : '值'
                                },
                                // 对于散点图，使用线性刻度
                                type: chartType === 'scatter' ? 'linear' : 'category',
                                // 散点图不显示标签
                                ticks: {
                                    display: chartType !== 'scatter'
                                }
                            }
                        }
                    }
                });
            }
            
            // 创建直方图的分箱
            createHistogramBins(data, numBins = 50) {
                if (data.length === 0) return [];
                
                const sortedData = [...data].sort((a, b) => a - b);
                const min = sortedData[0];
                const max = sortedData[sortedData.length - 1];
                
                // 处理所有值相同的情况
                if (min === max) {
                    return [{ midpoint: min, count: data.length }];
                }
                
                const binWidth = (max - min) / numBins;
                const bins = Array(numBins).fill().map((_, i) => ({
                    min: min + i * binWidth,
                    max: min + (i + 1) * binWidth,
                    count: 0
                }));
                
                // 计算每个分箱的频数
                for (const value of data) {
                    // 确保最大值被包含在最后一个分箱
                    if (value === max) {
                        bins[bins.length - 1].count++;
                    } else {
                        const binIndex = Math.floor((value - min) / binWidth);
                        if (binIndex >= 0 && binIndex < bins.length) {
                            bins[binIndex].count++;
                        }
                    }
                }
                
                // 计算中点并过滤掉空的分箱
                return bins
                    .filter(bin => bin.count > 0)
                    .map(bin => ({
                        midpoint: (bin.min + bin.max) / 2,
                        count: bin.count
                    }));
            }
        }
        
        // 概率分布应用主类
        class ProbabilityApp {
            constructor() {
                this.calculator = new DistributionCalculator();
                this.analyzer = new StatisticalAnalyzer();
                this.visualizer = new DataVisualizer();
                this.currentData = null;
                this.currentDistribution = null;
                this.currentParams = null;
                
                // 初始化AI集成
                this.initAI();
                
                this.init();
            }
            
            // 初始化AI集成
            initAI() {
                // 检查是否已经加载了DashScopeIntegration类
                if (typeof DashScopeIntegration !== 'undefined') {
                    this.ai = new DashScopeIntegration();
                    this.ai.loadApiKey();
                    // 添加isConfigured属性
                    this.ai.isConfigured = this.ai.apiKey && this.ai.apiKey.length > 0;
                } else {
                    // 如果没有加载DashScopeIntegration类，创建一个简单的模拟对象
                    this.ai = {
                        isConfigured: false,
                        apiKey: '',
                        loadApiKey: function() { 
                            // 尝试从localStorage加载API密钥
                            const key = localStorage.getItem('dashscope-api-key');
                            this.apiKey = key || '';
                            this.isConfigured = this.apiKey.length > 0;
                            return this.isConfigured;
                        },
                        generateDistributionData: async function() { 
                            throw new Error('DashScope Integration not loaded'); 
                        }
                    };
                    
                    // 尝试动态加载dashscope_integration.js
                    this.loadAIScript();
                }
            }
            
            // 动态加载AI脚本
            loadAIScript() {
                const script = document.createElement('script');
                script.src = 'dashscope_integration.js';
                script.onload = () => {
                    console.log('DashScope Integration script loaded');
                    this.ai = new DashScopeIntegration();
                    this.ai.loadApiKey();
                    this.ai.isConfigured = this.ai.apiKey && this.ai.apiKey.length > 0;
                    // 为DashScopeIntegration添加generateDistributionData方法
                    this.extendDashScopeIntegration();
                };
                script.onerror = () => {
                    console.warn('Failed to load DashScope Integration script');
                };
                document.head.appendChild(script);
            }
            
            // 扩展DashScopeIntegration类，添加generateDistributionData方法
            extendDashScopeIntegration() {
                if (typeof DashScopeIntegration !== 'undefined' && !DashScopeIntegration.prototype.generateDistributionData) {
                    DashScopeIntegration.prototype.generateDistributionData = async function(description) {
                        const prompt = `分析以下描述并生成符合要求的概率分布数据：\n"${description}"\n\n请返回以下格式的JSON：\n{\n  "title": "生成数据的标题",\n  "values": [数值1, 数值2, 数值3, ...]\n}\n\n注意事项：\n- 确保values数组包含100-2000个数值\n- 不要包含任何额外的文字说明\n- 只返回纯JSON格式数据，不要有其他内容`;
                        
                        try {
                            // 检查是否已经设置了API密钥
                            if (!this.apiKey) {
                                throw new Error('API密钥未设置');
                            }
                            
                            const response = await fetch(`${this.baseUrl}/services/aigc/text-generation/generation`, {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${this.apiKey}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    model: this.model,
                                    input: {
                                        messages: [
                                            { role: 'user', content: prompt }
                                        ]
                                    }
                                })
                            });
                            
                            if (response.ok) {
                                const result = await response.json();
                                const aiText = result.output.text;
                                // 尝试从响应中提取JSON
                                const jsonMatch = aiText.match(/\{[\s\S]*\}/);
                                if (jsonMatch) {
                                    const data = JSON.parse(jsonMatch[0]);
                                    return data;
                                }
                                console.error('无法从AI响应中提取有效的JSON:', aiText);
                                throw new Error('无法从AI响应中提取有效的JSON');
                            } else {
                                const errorText = await response.text();
                                console.error('API调用失败:', response.status, errorText);
                                throw new Error(`API调用失败: ${response.status}`);
                            }
                        } catch (error) {
                            console.error('API调用失败:', error);
                            throw error;
                        }
                    };
                }
            }
            
            // 显示AI设置对话框
            showAISetup() {
                return new Promise((resolve, reject) => {
                    // 检查是否已经存在设置对话框
                    let dialog = document.getElementById('ai-setup-dialog');
                    
                    if (!dialog) {
                        // 创建设置对话框
                        dialog = document.createElement('div');
                        dialog.id = 'ai-setup-dialog';
                        dialog.style.cssText = `
                            position: fixed;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            background: white;
                            padding: 20px;
                            border-radius: 8px;
                            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                            z-index: 1000;
                            width: 400px;
                            max-width: 90%;
                        `;
                        
                        dialog.innerHTML = `
                            <h3 style="margin-top: 0; color: #333;">AI API 设置</h3>
                            <p style="color: #666; margin-bottom: 20px;">请输入您的DashScope API密钥以启用AI功能。</p>
                            <div style="margin-bottom: 15px;">
                                <label for="api-key-input" style="display: block; margin-bottom: 5px; color: #555;">API密钥:</label>
                                <input 
                                    type="text" 
                                    id="api-key-input" 
                                    style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;"
                                    placeholder="请输入您的DashScope API密钥"
                                >
                            </div>
                            <div style="text-align: right;">
                                <button 
                                    id="cancel-api-setup" 
                                    style="padding: 8px 16px; margin-right: 10px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;"
                                >
                                    取消
                                </button>
                                <button 
                                    id="save-api-setup" 
                                    style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;"
                                >
                                    保存
                                </button>
                            </div>
                        `;
                        
                        // 添加蒙层
                        const overlay = document.createElement('div');
                        overlay.id = 'ai-setup-overlay';
                        overlay.style.cssText = `
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background: rgba(0,0,0,0.5);
                            z-index: 999;
                        `;
                        
                        document.body.appendChild(overlay);
                        document.body.appendChild(dialog);
                    }
                    
                    // 设置按钮事件
                    const cancelButton = document.getElementById('cancel-api-setup');
                    const saveButton = document.getElementById('save-api-setup');
                    const apiKeyInput = document.getElementById('api-key-input');
                    
                    // 如果已有API密钥，预填
                    if (this.ai && this.ai.apiKey) {
                        apiKeyInput.value = this.ai.apiKey;
                    }
                    
                    // 移除之前的事件监听器
                    const newCancelButton = cancelButton.cloneNode(true);
                    const newSaveButton = saveButton.cloneNode(true);
                    cancelButton.parentNode.replaceChild(newCancelButton, cancelButton);
                    saveButton.parentNode.replaceChild(newSaveButton, saveButton);
                    
                    // 添加新的事件监听器
                    newCancelButton.addEventListener('click', () => {
                        // 移除对话框
                        const dialog = document.getElementById('ai-setup-dialog');
                        const overlay = document.getElementById('ai-setup-overlay');
                        if (dialog) document.body.removeChild(dialog);
                        if (overlay) document.body.removeChild(overlay);
                        
                        reject(new Error('用户取消设置'));
                    });
                    
                    newSaveButton.addEventListener('click', () => {
                        const apiKey = apiKeyInput.value.trim();
                        
                        if (apiKey) {
                            // 保存API密钥
                            localStorage.setItem('dashscope-api-key', apiKey);
                            
                            // 更新AI配置
                            if (this.ai) {
                                this.ai.apiKey = apiKey;
                                this.ai.isConfigured = true;
                            }
                            
                            // 移除对话框
                            const dialog = document.getElementById('ai-setup-dialog');
                            const overlay = document.getElementById('ai-setup-overlay');
                            if (dialog) document.body.removeChild(dialog);
                            if (overlay) document.body.removeChild(overlay);
                            
                            resolve();
                        } else {
                            alert('请输入有效的API密钥');
                        }
                    });
                });
            }
            
            init() {
                this.setupTabs();
                this.setupDistributionTypeChange();
                this.setupGenerateButton();
                this.setupAIGenerateButton();
                this.setupFileUpload();
                this.updateParameterControls();
                this.setupChartTypeChangeListener();
            }
            
            // 设置图表类型切换事件
            setupChartTypeChangeListener() {
                const chartTypeSelect = document.getElementById('chart-type');
                if (chartTypeSelect && !chartTypeSelect.hasAttribute('data-listener-added')) {
                    chartTypeSelect.addEventListener('change', () => {
                        if (this.currentData) {
                            // 重新绘制图表
                            this.visualizer.createDistributionChart(
                                'distribution-chart', 
                                this.currentData, 
                                this.currentDistribution,
                                this.currentParams
                            );
                        }
                    });
                    chartTypeSelect.setAttribute('data-listener-added', 'true');
                }
            }
            
            // 设置标签页切换
            setupTabs() {
                const tabs = document.querySelectorAll('.tab');
                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        const tabId = tab.getAttribute('data-tab');
                        
                        // 移除所有标签的活动状态
                        tabs.forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
                        
                        // 激活当前标签和面板
                        tab.classList.add('active');
                        document.getElementById(tabId).classList.add('active');
                    });
                });
            }
            
            // 设置分布类型变更
            setupDistributionTypeChange() {
                const distributionTypeSelect = document.getElementById('distribution-type');
                distributionTypeSelect.addEventListener('change', () => {
                    this.updateParameterControls();
                    this.updateDistributionInfo();
                });
            }
            
            // 更新参数控件
            updateParameterControls() {
                const distributionType = document.getElementById('distribution-type').value;
                const paramGroups = document.querySelectorAll('.param-group');
                
                // 隐藏所有参数组
                paramGroups.forEach(group => {
                    group.style.display = 'none';
                });
                
                // 显示当前分布类型的参数组
                switch (distributionType) {
                    case 'normal':
                        document.getElementById('normal-params').style.display = 'flex';
                        break;
                    case 'binomial':
                        document.getElementById('binomial-params').style.display = 'flex';
                        break;
                    case 'poisson':
                        document.getElementById('poisson-params').style.display = 'flex';
                        break;
                    case 'exponential':
                        document.getElementById('exponential-params').style.display = 'flex';
                        break;
                    case 'uniform':
                        document.getElementById('uniform-params').style.display = 'flex';
                        break;
                }
            }
            
            // 更新分布信息
            updateDistributionInfo() {
                const distributionType = document.getElementById('distribution-type').value;
                const distributionInfo = document.getElementById('distribution-info');
                
                let infoText = '';
                switch (distributionType) {
                    case 'normal':
                        infoText = '正态分布（高斯分布）是一种对称的概率分布，由均值和标准差参数化。常用于自然现象和测量误差的建模。';
                        break;
                    case 'binomial':
                        infoText = '二项分布描述了在n次独立的是/非试验中成功k次的概率，每次试验成功的概率为p。';
                        break;
                    case 'poisson':
                        infoText = '泊松分布描述了在固定时间或空间内发生k次事件的概率，事件以已知的恒定速率λ发生且独立于上次事件的时间。';
                        break;
                    case 'exponential':
                        infoText = '指数分布描述了独立同分布的时间间隔的概率，常用于模拟等待时间和可靠性分析。';
                        break;
                    case 'uniform':
                        infoText = '均匀分布在区间[a, b]内的所有值具有相等的概率密度。';
                        break;
                }
                
                distributionInfo.textContent = infoText;
            }
            
            // 设置生成按钮
            setupGenerateButton() {
                const generateButton = document.getElementById('generate-btn');
                generateButton.addEventListener('click', () => {
                    this.generateData();
                });
            }
            
            // 生成数据
            generateData() {
                const distributionType = document.getElementById('distribution-type').value;
                const sampleSize = parseInt(document.getElementById('sample-size').value) || 1000;
                
                let data = [];
                let params = {};
                
                switch (distributionType) {
                    case 'normal':
                        const mean = parseFloat(document.getElementById('mean').value) || 0;
                        const stdDev = parseFloat(document.getElementById('std-dev').value) || 1;
                        data = this.calculator.generateNormal(mean, stdDev, sampleSize);
                        params = { mean, stdDev };
                        break;
                    case 'binomial':
                        const trials = parseInt(document.getElementById('trials').value) || 10;
                        const probability = parseFloat(document.getElementById('probability').value) || 0.5;
                        data = this.calculator.generateBinomial(trials, probability, sampleSize);
                        params = { trials, probability };
                        break;
                    case 'poisson':
                        const lambda = parseFloat(document.getElementById('lambda').value) || 5;
                        data = this.calculator.generatePoisson(lambda, sampleSize);
                        params = { lambda };
                        break;
                    case 'exponential':
                        const rate = parseFloat(document.getElementById('rate').value) || 1;
                        data = this.calculator.generateExponential(rate, sampleSize);
                        params = { rate };
                        break;
                    case 'uniform':
                        const min = parseFloat(document.getElementById('min').value) || 0;
                        const max = parseFloat(document.getElementById('max').value) || 1;
                        data = this.calculator.generateUniform(min, max, sampleSize);
                        params = { min, max };
                        break;
                }
                
                this.currentData = data;
                this.currentDistribution = distributionType;
                this.currentParams = params;
                
                // 绘制图表
                this.visualizer.createDistributionChart('distribution-chart', data, distributionType, params);
                
                // 更新分析结果
                this.updateAnalysisResults();
            }
            
            // 更新分析结果
            updateAnalysisResults() {
                if (!this.currentData || this.currentData.length === 0) {
                    return;
                }
                
                const resultsContainer = document.getElementById('analysis-results');
                resultsContainer.innerHTML = '';
                
                const stats = {
                    '样本大小': this.currentData.length,
                    '均值': this.analyzer.mean(this.currentData).toFixed(4),
                    '中位数': this.analyzer.median(this.currentData).toFixed(4),
                    '众数': this.analyzer.mode(this.currentData).join(', '),
                    '最小值': this.analyzer.min(this.currentData).toFixed(4),
                    '最大值': this.analyzer.max(this.currentData).toFixed(4),
                    '方差': this.analyzer.variance(this.currentData).toFixed(4),
                    '标准差': this.analyzer.stdDev(this.currentData).toFixed(4),
                    '偏度': this.analyzer.skewness(this.currentData).toFixed(4),
                    '峰度': this.analyzer.kurtosis(this.currentData).toFixed(4)
                };
                
                // 添加四分位数
                const quartiles = this.analyzer.quartiles(this.currentData);
                stats['第一四分位数 (Q1)'] = quartiles.q1.toFixed(4);
                stats['第三四分位数 (Q3)'] = quartiles.q3.toFixed(4);
                
                // 创建结果卡片
                for (const [label, value] of Object.entries(stats)) {
                    const card = document.createElement('div');
                    card.className = 'result-card';
                    
                    const labelEl = document.createElement('div');
                    labelEl.className = 'result-label';
                    labelEl.textContent = label;
                    
                    const valueEl = document.createElement('div');
                    valueEl.className = 'result-value';
                    valueEl.textContent = value;
                    
                    card.appendChild(labelEl);
                    card.appendChild(valueEl);
                    resultsContainer.appendChild(card);
                }
            }
            
            // 设置AI生成按钮和API设置按钮
            setupAIGenerateButton() {
                const aiGenerateButton = document.getElementById('ai-generate-btn');
                aiGenerateButton.addEventListener('click', () => {
                    this.analyzeAIDescriptionAndGenerateData();
                });
                
                // 添加API设置按钮的点击事件
                const aiApiSetupButton = document.getElementById('ai-api-setup-btn');
                aiApiSetupButton.addEventListener('click', async () => {
                    try {
                        await this.showAISetup();
                        alert('API密钥设置成功！您现在可以使用AI生成数据功能了。');
                    } catch (error) {
                        // 用户取消设置
                        if (error.message !== '用户取消设置') {
                            console.error('API设置失败:', error);
                        }
                    }
                });
            }
            
            // 分析AI描述并生成数据
            async analyzeAIDescriptionAndGenerateData() {
                const aiDescription = document.getElementById('ai-description').value.trim();
                
                if (!aiDescription) {
                    alert('请输入数据模式描述');
                    return;
                }
                
                // 显示加载指示器
                const loadingIndicator = document.getElementById('loading');
                loadingIndicator.style.display = 'block';
                
                try {
                    // 检查是否已配置AI
                    if (!this.ai || !this.ai.isConfigured) {
                        // 提示用户设置API密钥
                        if (!confirm('AI功能需要配置DashScope API密钥。是否现在设置？')) {
                            loadingIndicator.style.display = 'none';
                            return;
                        }
                        
                        // 显示API设置对话框
                        await this.showAISetup();
                        
                        // 如果用户取消设置，使用模拟数据
                        if (!this.ai || !this.ai.isConfigured) {
                            console.log('使用模拟AI数据，因为未配置API密钥');
                            this.generateMockAIData(aiDescription, loadingIndicator);
                            return;
                        }
                    }
                    
                    // 使用真实AI生成数据
                    let data = [];
                    let chartTitle = 'AI生成数据';
                    
                    // 调用DashScope API进行分析
                    const distributionData = await this.ai.generateDistributionData(aiDescription);
                    
                    if (distributionData && distributionData.values && distributionData.values.length > 0) {
                        data = distributionData.values;
                        chartTitle = distributionData.title || `AI生成的数据（${data.length}个样本）`;
                    } else {
                        // 备用方案：生成随机数据
                        data = Array(1000).fill().map(() => Math.random() * 100);
                        chartTitle = 'AI生成的数据（备用方案）';
                    }
                    
                    this.currentData = data;
                    this.currentDistribution = 'ai-generated';
                    this.currentParams = {};
                    
                    // 绘制图表
                    this.visualizer.createDistributionChart('distribution-chart', data, 'normal', { mean: 0, stdDev: 1 }, chartTitle);
                    // 确保图表类型选择器的事件监听已设置
                    this.setupChartTypeChangeListener();
                    
                    // 更新分析结果
                    this.updateAnalysisResults();
                } catch (error) {
                    console.error('AI生成数据失败:', error);
                    alert(`AI生成数据失败：${error.message}\n将使用模拟数据代替。`);
                    this.generateMockAIData(aiDescription, loadingIndicator);
                } finally {
                    // 隐藏加载指示器
                    loadingIndicator.style.display = 'none';
                }
            }
            
            // 生成模拟AI数据（作为备用方案）
            generateMockAIData(aiDescription, loadingIndicator) {
                // 根据描述生成简单的模拟数据
                let data = [];
                let chartTitle = '模拟AI数据';
                
                if (aiDescription.includes('正态') || aiDescription.includes('高斯')) {
                    // 尝试提取均值和标准差
                    const meanMatch = aiDescription.match(/均值\s*(\d+(?:\.\d+)?)/);
                    const stdDevMatch = aiDescription.match(/标准差\s*(\d+(?:\.\d+)?)/);
                    const countMatch = aiDescription.match(/(\d+)个样本|样本大小(\d+)|样本数(\d+)/);
                    
                    const mean = meanMatch ? parseFloat(meanMatch[1]) : 0;
                    const stdDev = stdDevMatch ? parseFloat(stdDevMatch[1]) : 1;
                    let sampleSize = 1000;
                    
                    if (countMatch) {
                        sampleSize = parseInt(countMatch[1] || countMatch[2] || countMatch[3]) || 1000;
                    }
                    
                    data = this.calculator.generateNormal(mean, stdDev, sampleSize);
                    chartTitle = `模拟正态分布数据 (均值=${mean}, 标准差=${stdDev})`;
                } else if (aiDescription.includes('均匀')) {
                    // 尝试提取最小值和最大值
                    const minMatch = aiDescription.match(/最小值\s*(\d+(?:\.\d+)?)/);
                    const maxMatch = aiDescription.match(/最大值\s*(\d+(?:\.\d+)?)/);
                    
                    const min = minMatch ? parseFloat(minMatch[1]) : 0;
                    const max = maxMatch ? parseFloat(maxMatch[1]) : 1;
                    
                    data = this.calculator.generateUniform(min, max, 1000);
                    chartTitle = `模拟均匀分布数据 (范围=${min}-${max})`;
                } else if (aiDescription.includes('二项')) {
                    // 尝试提取试验次数和成功概率
                    const trialsMatch = aiDescription.match(/试验次数\s*(\d+)/);
                    const probMatch = aiDescription.match(/概率\s*(\d+(?:\.\d+)?)/);
                    
                    const trials = trialsMatch ? parseInt(trialsMatch[1]) : 10;
                    const probability = probMatch ? parseFloat(probMatch[1]) : 0.5;
                    
                    data = this.calculator.generateBinomial(trials, probability, 1000);
                    chartTitle = `模拟二项分布数据 (试验次数=${trials}, 成功概率=${probability})`;
                } else {
                    // 默认生成一些随机数据
                    data = Array(1000).fill().map(() => Math.random() * 100);
                }
                
                this.currentData = data;
                this.currentDistribution = 'ai-generated';
                this.currentParams = {};
                
                // 绘制图表
                this.visualizer.createDistributionChart('distribution-chart', data, 'normal', { mean: 0, stdDev: 1 }, chartTitle);
                // 确保图表类型选择器的事件监听已设置
                this.setupChartTypeChangeListener();
                
                // 更新分析结果
                this.updateAnalysisResults();
                
                // 隐藏加载指示器
                loadingIndicator.style.display = 'none';
            }
            
            // 设置文件上传
            setupFileUpload() {
                const fileInput = document.getElementById('file-upload');
                const fileNameDisplay = document.getElementById('file-name');
                const uploadButton = document.getElementById('upload-btn');
                
                // 更新文件名显示
                fileInput.addEventListener('change', () => {
                    if (fileInput.files.length > 0) {
                        fileNameDisplay.textContent = fileInput.files[0].name;
                    } else {
                        fileNameDisplay.textContent = '未选择文件';
                    }
                });
                
                // 上传按钮点击事件
                uploadButton.addEventListener('click', () => {
                    if (fileInput.files.length === 0) {
                        alert('请先选择一个文件');
                        return;
                    }
                    
                    const file = fileInput.files[0];
                    const dataColumn = document.getElementById('data-column').value.trim();
                    
                    // 显示加载指示器
                    const loadingIndicator = document.getElementById('loading');
                    loadingIndicator.style.display = 'block';
                    
                    this.readCSVFile(file, dataColumn);
                });
            }
            
            // 读取CSV文件
            readCSVFile(file, targetColumn = '') {
                const reader = new FileReader();
                
                reader.onload = (event) => {
                    try {
                        const content = event.target.result;
                        const lines = content.split('\n').filter(line => line.trim() !== '');
                        
                        if (lines.length === 0) {
                            alert('文件为空');
                            return;
                        }
                        
                        // 解析表头
                        const headers = lines[0].split(',').map(header => header.trim());
                        
                        // 确定目标列
                        let columnIndex = -1;
                        
                        if (targetColumn) {
                            // 查找指定的列名
                            columnIndex = headers.findIndex(header => 
                                header.toLowerCase() === targetColumn.toLowerCase() ||
                                header.toLowerCase().includes(targetColumn.toLowerCase())
                            );
                        } else {
                            // 自动选择可能包含数值数据的列
                            for (let i = 0; i < Math.min(5, headers.length); i++) {
                                if (!isNaN(parseFloat(headers[i]))) {
                                    columnIndex = i;
                                    break;
                                }
                            }
                            
                            // 如果没有找到明显的数值列，使用第一列
                            if (columnIndex === -1) {
                                columnIndex = 0;
                            }
                        }
                        
                        if (columnIndex === -1) {
                            alert(`未找到列名包含 "${targetColumn}" 的列`);
                            return;
                        }
                        
                        // 解析数据
                        const data = [];
                        for (let i = 1; i < lines.length; i++) {
                            const values = lines[i].split(',');
                            const value = parseFloat(values[columnIndex]);
                            
                            if (!isNaN(value)) {
                                data.push(value);
                            }
                        }
                        
                        if (data.length === 0) {
                            alert('未找到有效的数值数据');
                            return;
                        }
                        
                        this.currentData = data;
                        this.currentDistribution = 'uploaded';
                        this.currentParams = {};
                        
                        // 绘制图表
                        this.visualizer.createDistributionChart(
                            'distribution-chart', 
                            data, 
                            'normal', 
                            { mean: 0, stdDev: 1 },
                            `上传数据分析 (${file.name})`
                        );
                        // 确保图表类型选择器的事件监听已设置
                        this.setupChartTypeChangeListener();
                        
                        // 更新分析结果
                        this.updateAnalysisResults();
                        
                    } catch (error) {
                        console.error('读取文件时出错:', error);
                        alert('读取文件时出错，请确保文件格式正确');
                    } finally {
                        // 隐藏加载指示器
                        const loadingIndicator = document.getElementById('loading');
                        loadingIndicator.style.display = 'none';
                    }
                };
                
                reader.onerror = () => {
                    alert('读取文件时出错');
                    const loadingIndicator = document.getElementById('loading');
                    loadingIndicator.style.display = 'none';
                };
                
                reader.readAsText(file);
            }
        }
        
        // 初始化应用
        document.addEventListener('DOMContentLoaded', () => {
            const app = new ProbabilityApp();
        });
    </script>
</body>
</html>